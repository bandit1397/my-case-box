<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‹¨ì† ë²•ê·œ ê²€ìƒ‰ ì‹œìŠ¤í…œ</title>

<style>
  body {
    font-family: "Apple SD Gothic Neo", sans-serif;
    margin: 0;
    background: #f5f5f5;
    display: flex;
    height: 100vh;
  }

  /* ===== ì™¼ìª½ ë¶„ë¥˜ íŒ¨ë„ ===== */
  #leftPanel {
    width: 220px;
    background: #ffffff;
    border-right: 1px solid #ddd;
    padding: 15px;
    overflow-y: auto;
  }

  #leftPanel h2 {
    margin-top: 0;
    font-size: 1.1em;
    color: #333;
  }

  .categoryItem {
    margin-bottom: 10px;
  }

  .categoryItem label {
    cursor: pointer;
    font-size: 0.95em;
  }

  /* ===== ì˜¤ë¥¸ìª½ ë©”ì¸ ì˜ì—­ ===== */
  #rightPanel {
    flex: 1;
    padding: 20px;
  }

  h1 {
    text-align: center;
    color: #333;
  }

  #searchBox {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-bottom: 20px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #results {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }

  .lawItem {
    margin-bottom: 15px;
    padding: 12px;
    border-left: 5px solid #007bff;
  }

  .lawItem h3 {
    margin: 0 0 6px 0;
    font-size: 1.05em;
    color: #007bff;
  }

  .note {
    margin-top: 6px;
    font-size: 0.9em;
    color: #ff6600;
    white-space: pre-line;
  }

  .highlight {
    background-color: #fff3cd;
    color: #d63300;
    font-weight: 600;
    padding: 0 2px;
    border-radius: 3px;
  }

</style>
</head>

<body>

<!-- ================== ì™¼ìª½ ë¶„ë¥˜ UI  ================== -->
<div id="leftPanel">
  <h2>ê²€ìƒ‰ ë²”ìœ„</h2>

  <div class="categoryItem">
    <input type="checkbox" value="criminal" checked>
    <label>í˜•ì‚¬</label>
  </div>

  <div class="categoryItem">
    <input type="checkbox" value="traffic" checked>
    <label>êµí†µ</label>
  </div>

  <div class="categoryItem">
    <input type="checkbox" value="contacts" checked>
    <label>ì—°ë½ì²˜</label>
  </div>

  <div class="categoryItem">
    <input type="checkbox" value="procedure" checked>
    <label>ì ˆì°¨</label>
  </div>

  <div class="categoryItem">
    <input type="checkbox" value="admin" checked>
    <label>í–‰ì •</label>
  </div>

  <br><br>

  <h2>ê³ ì§€ ì–¸ì–´</h2>
  <select id="langSelect">
    <option value="ko" selected>í•œêµ­ì–´</option>
    <option value="en">English</option>
    <option value="zh">ä¸­æ–‡</option>
    <option value="ja">æ—¥æœ¬èª</option>
    <option value="vi">Tiáº¿ng Viá»‡t</option>
  </select>

</div>

<!-- ================== ì˜¤ë¥¸ìª½ ê²€ìƒ‰ ì˜ì—­ ================== -->
<div id="rightPanel">

  <h1>ì—…ë¬´ ê²€ìƒ‰ ë°•ìŠ¤</h1>

  <input
    type="text"
    id="searchBox"
    placeholder="ë‹¨ì–´ ì…ë ¥ (ì˜ˆ: ë…¸ì , ì²­ì†Œë…„, ì‹¬ì•¼, ì‹ í˜¸ìœ„ë°˜)"
    disabled
  />

  <!-- ================== ìŒì„± ì¶œë ¥ ì˜µì…˜ ================== -->
  <hr>
  <h2>ìŒì„± ì¶œë ¥</h2>
  <label>
    <input type="checkbox" id="ttsSwitch" checked>
    ê³ ì§€ë¬¸ ë²„íŠ¼ í‘œì‹œ
  </label>

  <div id="results">
    <p class="loading">ë²•ê·œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

</div>

<script>
// ===============================
// 1. ì „ì—­ ë°ì´í„°
// ===============================
let lawsData = [];
let selectedLang = "ko";

// ===============================
// 2. JSON ë¡œë”© (ë‹¤ì¤‘ íŒŒì¼ í†µí•©)
// ===============================
const jsonFiles = [
  { file: "./data/laws_criminal.json", category: "criminal" },
  { file: "./data/laws_traffic.json", category: "traffic" },
  { file: "./data/laws_contacts.json", category: "contacts" },
  { file: "./data/laws_procedure.json", category: "procedure" },
  { file: "./data/laws_admin.json", category: "admin" }
];

Promise.allSettled(
  jsonFiles.map(info =>
    fetch(info.file)
      .then(res => res.ok ? res.json() : [])
      .then(data =>
        data.map(item => ({
          ...item,
          _category: info.category   // â­ í•µì‹¬
        }))
      )
  )
).then(results => {
  lawsData = results
    .filter(r => r.status === "fulfilled")
    .flatMap(r => r.value);

  document.getElementById("searchBox").disabled = false;
  document.getElementById("results").innerHTML =
    "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>";
});



// ===============================
// 3. ë²ˆí˜¸ ì œê±° í•¨ìˆ˜ (TTS ì „ìš©)
// ===============================
function removeLeadingNumbers(text) {
  return text
    .replace(/^\s*\d+[\.\)\-]?\s*/gm, "")
    .replace(/\n{2,}/g, "\n")
    .trim();
}

// ===============================
// 3.1 í‚¤ì›Œë“œ ê°•ì¡° í•¨ìˆ˜
// ===============================

function highlightText(text, keywords) {
  if (!text || keywords.length === 0) return text;

  let highlighted = text;

  keywords.forEach(keyword => {
    if (!keyword) return;

    const regex = new RegExp(`(${keyword})`, "gi");
    highlighted = highlighted.replace(
      regex,
      `<span class="highlight">$1</span>`
    );
  });

  return highlighted;
}
  
// ===============================
// 3.2 ì „í™”ë²ˆí˜¸ ìë™ ë§í¬ í•¨ìˆ˜
// ===============================
function linkifyPhoneNumbers(text) {
  if (!text) return text;

  // í•œêµ­ ì „í™”ë²ˆí˜¸ íŒ¨í„´ (02-XXXX-XXXX, 010-XXXX-XXXX ë“±)
  const phoneRegex = /(\d{2,3}-\d{3,4}-\d{4})/g;

  return text.replace(phoneRegex, number => {
    const telNumber = number.replace(/-/g, "");
    return `<a href="tel:${telNumber}" style="color:#007bff; text-decoration:underline;">${number}</a>`;
  });
}

// âœ… 3.3 ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸° (â† ì—¬ê¸°ì— ìœ„ì¹˜)
// ===============================
function getSelectedCategories() {
  return Array.from(
    document.querySelectorAll('input[type="checkbox"]:checked')
  ).map(cb => cb.value);
}



// ===============================
// 4. ê²€ìƒ‰ í•¨ìˆ˜ (ë‹¤ì¤‘ í‚¤ì›Œë“œ AND + TAG ê²€ìƒ‰ í¬í•¨)
// ===============================
function searchLaw() {

  const input = document.getElementById("searchBox").value;
  const keywords = input
    .split(",")
    .map(k => k.trim().toLowerCase())
    .filter(k => k.length > 0);

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if (keywords.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>";
    return;
  }

  let selectedLang = document.getElementById("langSelect")?.value || "ko";
  let showTTS = document.getElementById("ttsSwitch")?.checked;

  const selectedCategories = getSelectedCategories();

  const results = lawsData.filter(item => {

    if (
      selectedCategories.length > 0 &&
      !selectedCategories.includes(item._category)
    ) {
      return false;
    }

    const lawText = (item.law || []).join(" ").toLowerCase();

    const text = (item.text || "").toLowerCase();

    const noteText =
      typeof item.note === "string"
        ? item.note
        : item.note
        ? Object.values(item.note).join(" ")
        : "";
    const note = noteText.toLowerCase();

    let tagString = Array.isArray(item.tags)
      ? item.tags.join(" ").toLowerCase()
      : "";

    return keywords.every(keyword =>
      lawText.includes(keyword) ||
      text.includes(keyword) ||
      note.includes(keyword) ||
      tagString.includes(keyword)
    );
  });

  if (results.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  results.forEach(item => {
    const div = document.createElement("div");
    div.className = "lawItem";

    const highlightedLaw = highlightText(item.law.join(" "), keywords);

    const highlightedText =
      linkifyPhoneNumbers(
        highlightText(item.text || "", keywords)
      );

    let noteHtml = "";

    if (typeof item.note === "string") {
      noteHtml =
        `<p class="note">` +
        linkifyPhoneNumbers(
          highlightText(item.note, keywords)
        ) +
        `</p>`;
    }

    if (typeof item.note === "object") {

      const noteContent =
        item.note[selectedLang] ||
        item.note["ko"] ||
        Object.values(item.note)[0] ||
        "";

      noteHtml =
        `<p class="note">` +
        linkifyPhoneNumbers(
          highlightText(noteContent, keywords)
        ) +
        `</p>`;
    }

    let ttsText = "";

    if (item.ttsText) {
      ttsText = item.ttsText[selectedLang] || item.ttsText["ko"] || "";
    }

    div.innerHTML = `
      <h3>${highlightedLaw}</h3>

      <p class="textContent" style="white-space: pre-line;">
        ${highlightedText}
      </p>

      ${noteHtml}

      ${
        showTTS && ttsText
          ? `<button class="tts-btn" onclick="speakText(\`${ttsText}\`)">
              ğŸ”Š ê³ ì§€ë¬¸ ìŒì„± ì¶œë ¥
             </button>`
          : ""
      }
    `;

    resultsDiv.appendChild(div);
  });
}


// ===============================
// 5. TTS í•¨ìˆ˜
// ===============================
function speakText(text) {
  if (!("speechSynthesis" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¶œë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);

  const langMap = {
    ko: "ko-KR",
    en: "en-US",
    zh: "zh-CN",
    ja: "ja-JP",
    vi: "vi-VN"
  };

  utterance.lang = langMap[selectedLang] || "ko-KR";
  utterance.rate = 0.85;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  window.speechSynthesis.speak(utterance);
}

// ===============================
// 6. ì´ë²¤íŠ¸ ì—°ê²°
// ===============================
document
  .getElementById("searchBox")
  .addEventListener("input", searchLaw);

document
  .getElementById("langSelect")
  .addEventListener("change", e => {
    selectedLang = e.target.value;
    searchLaw();
  });

document
  .querySelectorAll('input[type="checkbox"]')
  .forEach(cb => {
    cb.addEventListener("change", searchLaw);
  });


</script>
</body>
</html>
