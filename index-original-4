<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‹¨ì† ë²•ê·œ ê²€ìƒ‰ ì‹œìŠ¤í…œ</title>

<style>
  body {
    font-family: "Apple SD Gothic Neo", sans-serif;
    margin: 20px;
    background: #f5f5f5;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  #searchBox {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-bottom: 20px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #results {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  .lawItem {
    margin-bottom: 15px;
    padding: 12px;
    border-left: 5px solid #007bff;
  }
  .lawItem h3 {
    margin: 0 0 6px 0;
    font-size: 1.05em;
    color: #007bff;
  }
  .textContent {
    margin: 0;
    font-size: 0.95em;
    line-height: 1.4;
    white-space: pre-line; /* âœ… text ì¤„ë°”ê¿ˆ ì ìš© */
  }
  .note {
    margin-top: 6px;
    font-size: 0.9em;
    color: #ff6600;
    white-space: pre-line; /* âœ… note ì¤„ë°”ê¿ˆ ì ìš© */
  }
  .tts-btn {
    margin-top: 8px;
    padding: 6px 10px;
    font-size: 0.9em;
    cursor: pointer;
  }
  .loading {
    text-align: center;
    color: #666;
    font-size: 0.9em;
  }
</style>
</head>

<body>

<h1>ì—…ë¬´ ê²€ìƒ‰ ë°•ìŠ¤</h1>

<div style="text-align:right; margin-bottom:10px;">
  ğŸŒ ê³ ì§€ ì–¸ì–´ :
  <select id="langSelect">
    <option value="ko" selected>í•œêµ­ì–´</option>
    <option value="en">English</option>
    <option value="zh">ä¸­æ–‡</option>
    <option value="ja">æ—¥æœ¬èª</option>
    <option value="vi">Tiáº¿ng Viá»‡t</option>
  </select>
</div>

<input
  type="text"
  id="searchBox"
  placeholder="ë‹¨ì–´ ì…ë ¥ (ì˜ˆ: ë…¸ì , ì²­ì†Œë…„, ì‹¬ì•¼, ì‹ í˜¸ìœ„ë°˜)"
  disabled
/>

<div id="results">
  <p class="loading">ë²•ê·œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<script>
// ===============================
// 1. ì „ì—­ ë°ì´í„°
// ===============================
let lawsData = [];
let selectedLang = "ko";

// ===============================
// 2. JSON ë¡œë”©
// ===============================
fetch("./lawsData.json")
  .then(res => {
    if (!res.ok) throw new Error("JSON ë¡œë”© ì‹¤íŒ¨");
    return res.json();
  })
  .then(data => {
    lawsData = data;
    document.getElementById("searchBox").disabled = false;
    document.getElementById("results").innerHTML =
      "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>";
  })
  .catch(err => {
    document.getElementById("results").innerHTML =
      "<p style='color:red;'>ë²•ê·œ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</p>";
    console.error(err);
  });

// ===============================
// 3. ë²ˆí˜¸ ì œê±° í•¨ìˆ˜ (TTS ì „ìš©)
// ===============================
function removeLeadingNumbers(text) {
  return text
    .replace(/^\s*\d+[\.\)\-]?\s*/gm, "")
    .replace(/\n{2,}/g, "\n")
    .trim();
}

// ===============================
// 4. ê²€ìƒ‰ í•¨ìˆ˜ (ë‹¤ì¤‘ í‚¤ì›Œë“œ AND)
// ===============================
function searchLaw() {
  const input = document.getElementById("searchBox").value;
  const keywords = input
    .split(",")
    .map(k => k.trim().toLowerCase())
    .filter(k => k.length > 0);

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if (keywords.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>";
    return;
  }

  const results = lawsData.filter(item => {
    const text = item.text.toLowerCase();
    const noteText =
      typeof item.note === "string"
        ? item.note
        : item.note
          ? Object.values(item.note).join(" ")
          : "";
    const note = noteText.toLowerCase();
    const lawText = item.law.join(" ").toLowerCase();

    return keywords.every(keyword =>
      text.includes(keyword) ||
      note.includes(keyword) ||
      lawText.includes(keyword)
    );
  });

  if (results.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  results.forEach(item => {
    const div = document.createElement("div");
    div.className = "lawItem";

    let noteHtml = "";
    let ttsText = "";

    // ì¼ë°˜ ë¬¸ìì—´ note
    if (typeof item.note === "string") {
      noteHtml = `<p class="note">${item.note}</p>`;
      ttsText = removeLeadingNumbers(item.note);
    }

    // í˜•ì‚¬ì†Œì†¡ë²• + ë‹¤êµ­ì–´
    if (item.law.includes("í˜•ì‚¬ì†Œì†¡ë²•") && typeof item.note === "object") {
      const text = item.note[selectedLang] || item.note["ko"];
      noteHtml = `<p class="note">${text}</p>`;
      ttsText = removeLeadingNumbers(text);
    }

    div.innerHTML = `
      <h3>${item.law.join(" / ")}</h3>
      <p class="textContent">${item.text}</p>
      ${noteHtml}
      ${ttsText ? `
        <button class="tts-btn" onclick="speakText(\`${ttsText}\`)">
          ğŸ”Š ì²´í¬ ê³ ì§€ë¬¸ ìŒì„± ì¶œë ¥
        </button>
      ` : ""}
    `;

    resultsDiv.appendChild(div);
  });
}

// ===============================
// 5. TTS í•¨ìˆ˜
// ===============================
function speakText(text) {
  if (!("speechSynthesis" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¶œë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);

  const langMap = {
    ko: "ko-KR",
    en: "en-US",
    zh: "zh-CN",
    ja: "ja-JP",
    vi: "vi-VN"
  };

  utterance.lang = langMap[selectedLang] || "ko-KR";
  utterance.rate = 0.85;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  window.speechSynthesis.speak(utterance);
}

// ===============================
// 6. ì´ë²¤íŠ¸ ì—°ê²°
// ===============================
document
  .getElementById("searchBox")
  .addEventListener("input", searchLaw);

document
  .getElementById("langSelect")
  .addEventListener("change", e => {
    selectedLang = e.target.value;
    searchLaw(); // ì–¸ì–´ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ì¶œë ¥
  });

</script>
</body>
</html>
