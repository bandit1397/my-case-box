<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‹¨ì† ë²•ê·œ ê²€ìƒ‰ ì‹œìŠ¤í…œ</title>

<style>
  body {
    font-family: "Apple SD Gothic Neo", sans-serif;
    margin: 20px;
    background: #f5f5f5;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  #searchBox {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-bottom: 20px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #results {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  .lawItem {
    margin-bottom: 15px;
    padding: 12px;
    border-left: 5px solid #007bff;
  }
  .lawItem h3 {
    margin: 0 0 6px 0;
    font-size: 1.05em;
    color: #007bff;
  }
  .textContent {
    margin: 0;
    font-size: 0.95em;
    line-height: 1.4;
    white-space: pre-line; /* âœ… text ì¤„ë°”ê¿ˆ ì ìš© */
  }
  .note {
    margin-top: 6px;
    font-size: 0.9em;
    color: #ff6600;
    white-space: pre-line; /* âœ… note ì¤„ë°”ê¿ˆ ì ìš© */
  }
  .tts-btn {
    margin-top: 8px;
    padding: 6px 10px;
    font-size: 0.9em;
    cursor: pointer;
  }
  .loading {
    text-align: center;
    color: #666;
    font-size: 0.9em;
  }
  .highlight {
    background-color: #fff3cd;   /* ì—°í•œ ë…¸ë‘ */
    color: #d63300;              /* ê°€ë…ì„± ì¢‹ì€ ê°•ì¡°ìƒ‰ */
    font-weight: 600;
    padding: 0 2px;
    border-radius: 3px;
  }
</style>
</head>

<body>

<h1>ì—…ë¬´ ê²€ìƒ‰ ë°•ìŠ¤</h1>

<div style="text-align:right; margin-bottom:10px;">
  ğŸŒ ê³ ì§€ ì–¸ì–´ :
  <select id="langSelect">
    <option value="ko" selected>í•œêµ­ì–´</option>
    <option value="en">English</option>
    <option value="zh">ä¸­æ–‡</option>
    <option value="ja">æ—¥æœ¬èª</option>
    <option value="vi">Tiáº¿ng Viá»‡t</option>
  </select>
</div>

<input
  type="text"
  id="searchBox"
  placeholder="ë‹¨ì–´ ì…ë ¥ (ì˜ˆ: ë…¸ì , ì²­ì†Œë…„, ì‹¬ì•¼, ì‹ í˜¸ìœ„ë°˜)"
  disabled
/>

<div id="results">
  <p class="loading">ë²•ê·œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<script>
// ===============================
// 1. ì „ì—­ ë°ì´í„°
// ===============================
let lawsData = [];
let selectedLang = "ko";

// ===============================
// 2. JSON ë¡œë”© (ë‹¤ì¤‘ íŒŒì¼ í†µí•©)
// ===============================
const jsonFiles = [
  "./data/laws_criminal.json",
  "./data/laws_traffic.json",
  "./data/laws_contacts.json",
  "./data/laws_procedure.json",
  "./data/laws_admin.json"
];

Promise.allSettled(
  jsonFiles.map(file =>
    fetch(file).then(res => res.ok ? res.json() : [])
  )
).then(results => {
  lawsData = results
    .filter(r => r.status === "fulfilled")
    .flatMap(r => r.value);

  document.getElementById("searchBox").disabled = false;
  document.getElementById("results").innerHTML =
    "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>";
});


// ===============================
// 3. ë²ˆí˜¸ ì œê±° í•¨ìˆ˜ (TTS ì „ìš©)
// ===============================
function removeLeadingNumbers(text) {
  return text
    .replace(/^\s*\d+[\.\)\-]?\s*/gm, "")
    .replace(/\n{2,}/g, "\n")
    .trim();
}

// ===============================
// 3.1 í‚¤ì›Œë“œ ê°•ì¡° í•¨ìˆ˜
// ===============================

function highlightText(text, keywords) {
  if (!text || keywords.length === 0) return text;

  let highlighted = text;

  keywords.forEach(keyword => {
    if (!keyword) return;

    const regex = new RegExp(`(${keyword})`, "gi");
    highlighted = highlighted.replace(
      regex,
      `<span class="highlight">$1</span>`
    );
  });

  return highlighted;
}
  
// ===============================
// 3.2 ì „í™”ë²ˆí˜¸ ìë™ ë§í¬ í•¨ìˆ˜
// ===============================
function linkifyPhoneNumbers(text) {
  if (!text) return text;

  // í•œêµ­ ì „í™”ë²ˆí˜¸ íŒ¨í„´ (02-XXXX-XXXX, 010-XXXX-XXXX ë“±)
  const phoneRegex = /(\d{2,3}-\d{3,4}-\d{4})/g;

  return text.replace(phoneRegex, number => {
    const telNumber = number.replace(/-/g, "");
    return `<a href="tel:${telNumber}" style="color:#007bff; text-decoration:underline;">${number}</a>`;
  });
}

// ===============================
// 4. ê²€ìƒ‰ í•¨ìˆ˜ (ë‹¤ì¤‘ í‚¤ì›Œë“œ AND)
// ===============================
function searchLaw() {
  const input = document.getElementById("searchBox").value;
  const keywords = input
    .split(",")
    .map(k => k.trim().toLowerCase())
    .filter(k => k.length > 0);

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if (keywords.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>";
    return;
  }

  const results = lawsData.filter(item => {
    const text = item.text.toLowerCase();
    const noteText =
      typeof item.note === "string"
        ? item.note
        : item.note
          ? Object.values(item.note).join(" ")
          : "";
    const note = noteText.toLowerCase();
    const lawText = item.law.join(" ").toLowerCase();

    return keywords.every(keyword =>
      text.includes(keyword) ||
      note.includes(keyword) ||
      lawText.includes(keyword)
    );
  });

  if (results.length === 0) {
    resultsDiv.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  results.forEach(item => {
    const div = document.createElement("div");
    div.className = "lawItem";

    let noteHtml = "";
    let ttsText = "";
    let showTTS = item.tts === true;

    // âœ… text í•˜ì´ë¼ì´íŠ¸
    const highlightedText = linkifyPhoneNumbers(
      highlightText(item.text, keywords)
    );


    // ì¼ë°˜ note
    if (typeof item.note === "string") {
      const highlightedNote = linkifyPhoneNumbers(
        highlightText(item.note, keywords)
      );
      noteHtml = `<p class="note">${highlightedNote}</p>`;
      ttsText = removeLeadingNumbers(item.note);
    }

    // ë‹¤êµ­ì–´ note
    if (typeof item.note === "object") {
      const rawText = item.note[selectedLang] || item.note["ko"];
      const highlightedNote = linkifyPhoneNumbers(
        highlightText(rawText, keywords)
      );

      noteHtml = `<p class="note">${highlightedNote}</p>`;
      ttsText = removeLeadingNumbers(rawText);
    }

    div.innerHTML = `
      <h3>${highlightText(item.law.join(" / "), keywords)}</h3>
      <p class="textContent" style="white-space: pre-line;">
        ${highlightedText}
      </p>
      ${noteHtml}
      ${
        showTTS && ttsText
          ? `<button class="tts-btn" onclick="speakText(\`${ttsText}\`)">
              ğŸ”Š ê³ ì§€ë¬¸ ìŒì„± ì¶œë ¥
             </button>`
          : ""
      }
    `;

    resultsDiv.appendChild(div);
  });

}

// ===============================
// 5. TTS í•¨ìˆ˜
// ===============================
function speakText(text) {
  if (!("speechSynthesis" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¶œë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);

  const langMap = {
    ko: "ko-KR",
    en: "en-US",
    zh: "zh-CN",
    ja: "ja-JP",
    vi: "vi-VN"
  };

  utterance.lang = langMap[selectedLang] || "ko-KR";
  utterance.rate = 0.85;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  window.speechSynthesis.speak(utterance);
}

// ===============================
// 6. ì´ë²¤íŠ¸ ì—°ê²°
// ===============================
document
  .getElementById("searchBox")
  .addEventListener("input", searchLaw);

document
  .getElementById("langSelect")
  .addEventListener("change", e => {
    selectedLang = e.target.value;
    searchLaw(); // ì–¸ì–´ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ì¶œë ¥
  });

</script>
</body>
</html>
